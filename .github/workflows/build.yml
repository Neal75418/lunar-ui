# GitHub Actions workflow for LunarUI build validation
# Runs on every push to main and pull requests

name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate TOC files
        run: |
          echo "Validating TOC files..."
          for toc in $(find . -name "*.toc" -not -path "./*/Libs/*"); do
            echo "Checking $toc"
            if ! grep -q "## Interface:" "$toc"; then
              echo "ERROR: Missing Interface in $toc"
              exit 1
            fi
            if ! grep -q "## Title:" "$toc"; then
              echo "ERROR: Missing Title in $toc"
              exit 1
            fi
          done
          echo "All TOC files valid!"

      - name: Check Lua syntax
        run: |
          echo "Checking Lua syntax..."
          sudo apt-get update && sudo apt-get install -y lua5.1
          find . -name "*.lua" -not -path "./*/Libs/*" | while read file; do
            echo "Checking $file"
            luac5.1 -p "$file" || exit 1
          done
          echo "All Lua files have valid syntax!"

      - name: Lint with luacheck
        run: |
          sudo apt-get install -y luarocks
          sudo luarocks install luacheck
          luacheck .

      - name: Run unit tests
        run: |
          sudo luarocks install busted
          busted spec/

      - name: Check formatting with StyLua
        run: |
          curl -sSL https://github.com/JohnnyMorganz/StyLua/releases/latest/download/stylua-linux-x86_64.zip -o stylua.zip
          unzip -q stylua.zip
          chmod +x stylua
          ./stylua --check --glob '**/*.lua' --glob '!LunarUI/Libs/**' .

      - name: Package addon (dry run)
        uses: BigWigsMods/packager@v2
        continue-on-error: true  # Don't fail build if packaging has issues (externals may be unavailable)
        with:
          args: -d -z  # Dry run, skip externals
